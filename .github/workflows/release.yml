name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: macos-26
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Build release (arm64)
        run: swift build -c release --arch arm64

      - name: Create app bundle
        run: |
          mkdir -p OpenWith.app/Contents/MacOS
          mkdir -p OpenWith.app/Contents/Resources
          cp .build/arm64-apple-macosx/release/OpenWith OpenWith.app/Contents/MacOS/
          VERSION="${GITHUB_REF_NAME#v}"
          cat > OpenWith.app/Contents/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>OpenWith</string>
              <key>CFBundleIdentifier</key>
              <string>com.rhnorskov.OpenWith</string>
              <key>CFBundleName</key>
              <string>OpenWith</string>
              <key>CFBundleDisplayName</key>
              <string>OpenWith</string>
              <key>CFBundleVersion</key>
              <string>${VERSION}</string>
              <key>CFBundleShortVersionString</key>
              <string>${VERSION}</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>26.0</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSUIElement</key>
              <false/>
          </dict>
          </plist>
          EOF

      - name: Create DMG
        run: |
          # Create staging directory
          mkdir -p dmg-staging
          cp -R OpenWith.app dmg-staging/
          ln -s /Applications dmg-staging/Applications

          # Create temporary DMG
          hdiutil create -volname "OpenWith" -srcfolder dmg-staging -ov -format UDRW temp.dmg

          # Mount and customize
          hdiutil attach temp.dmg -mountpoint /Volumes/OpenWith

          # Set window properties with AppleScript
          osascript << 'APPLESCRIPT'
          tell application "Finder"
            tell disk "OpenWith"
              open
              set current view of container window to icon view
              set toolbar visible of container window to false
              set statusbar visible of container window to false
              set bounds of container window to {400, 200, 900, 500}
              set theViewOptions to icon view options of container window
              set arrangement of theViewOptions to not arranged
              set icon size of theViewOptions to 80
              set position of item "OpenWith.app" of container window to {125, 150}
              set position of item "Applications" of container window to {375, 150}
              close
              open
              update without registering applications
            end tell
          end tell
          APPLESCRIPT

          # Finalize
          sync
          hdiutil detach /Volumes/OpenWith
          hdiutil convert temp.dmg -format UDZO -o OpenWith.dmg
          rm temp.dmg

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            OpenWith.dmg
          generate_release_notes: true
